<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - CRM</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <nav class="navbar">
  <div class="nav-brand">CRM</div>
  <div class="nav-links">
    <a href="/dashboard.html" class="active">Dashboard</a>
    <a href="/accounts.html">Accounts</a>
    <a href="/contacts.html">Contacts</a>
    <a href="/leads.html">Leads</a>
    <a href="/opportunities.html">Opportunities</a>
    <a href="/finance.html">Finance</a>
    <a href="/settings.html">Settings</a>
    <a href="#" id="logoutBtn">Logout</a>
  </div>
</nav>
  
  <div class="container">
    <h1>Dashboard</h1>
    
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Accounts</h3>
        <p class="stat-number" id="accountCount">-</p>
      </div>
      <div class="stat-card">
        <h3>Contacts</h3>
        <p class="stat-number" id="contactCount">-</p>
      </div>
      <div class="stat-card">
        <h3>Leads</h3>
        <p class="stat-number" id="leadCount">-</p>
      </div>
      <div class="stat-card">
        <h3>Opportunities</h3>
        <p class="stat-number" id="oppCount">-</p>
      </div>
    </div>

    <div class="section">
      <h2>Recent Opportunities</h2>
      <div id="recentOpportunities">Loading...</div>
    </div>

    <div class="section">
      <h2>Recent Activities</h2>
      <div id="recentActivities">Loading...</div>
    </div>
  </div>

  <script type="module" src="/js/config.js"></script>
  <script type="module" src="/js/auth.js"></script>
  <script type="module" src="/js/api.js"></script>
  <script type="module" src="/js/app.js"></script>
  <script type="module">
    import { requireAuth, handleLogout } from '/js/auth.js';
    import { api } from '/js/api.js';
    
    await requireAuth();
    
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      handleLogout();
    });

    async function loadDashboard() {
      try {
        const [accounts, contacts, leads, opportunities, activities] = await Promise.all([
          api.get('/accounts'),
          api.get('/contacts'),
          api.get('/leads'),
          api.get('/opportunities'),
          api.get('/activities')
        ]);

        document.getElementById('accountCount').textContent = accounts.length;
        document.getElementById('contactCount').textContent = contacts.length;
        document.getElementById('leadCount').textContent = leads.length;
        document.getElementById('oppCount').textContent = opportunities.length;

        const recentOpps = opportunities.slice(0, 5);
        const oppHtml = recentOpps.length > 0 
          ? `<table class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Stage</th>
                  <th>Amount</th>
                  <th>Close Date</th>
                </tr>
              </thead>
              <tbody>
                ${recentOpps.map(opp => `
                  <tr>
                    <td><a href="/opportunity-detail.html?id=${opp.id}">${opp.name}</a></td>
                    <td><span class="badge">${opp.stage}</span></td>
                    <td>${opp.amount ? '$' + parseFloat(opp.amount).toLocaleString() : '-'}</td>
                    <td>${opp.close_date || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>`
          : '<p>No opportunities yet</p>';
        
        document.getElementById('recentOpportunities').innerHTML = oppHtml;

        const recentActs = activities.slice(0, 5);
        const actHtml = recentActs.length > 0
          ? `<table class="data-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Subject</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                ${recentActs.map(act => `
                  <tr>
                    <td><span class="badge">${act.type}</span></td>
                    <td>${act.subject}</td>
                    <td>${new Date(act.created_at).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>`
          : '<p>No activities yet</p>';
        
        document.getElementById('recentActivities').innerHTML = actHtml;

      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    loadDashboard();
  </script>
</body>
</html>